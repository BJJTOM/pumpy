# 🆘 긴급 인스턴스 복구 가이드

## 🚨 상황: 재부팅 후에도 연결성 검사 실패

---

## ✅ 해결 방법 (순서대로 시도)

### 방법 1: 인스턴스 중지 → 시작 (필수!)

**재부팅과 다릅니다! 더 강력한 방법입니다.**

#### 단계:

1. **AWS EC2 콘솔에서 인스턴스 선택**

2. **인스턴스 상태** → **인스턴스 중지**
   - ⚠️ "중지"를 클릭하면 경고 메시지가 나옴
   - **"중지"** 확인 클릭

3. **대기 (1-2분)**
   - 상태가 **"중지됨"**으로 변할 때까지 기다림

4. **인스턴스 상태** → **인스턴스 시작**
   - **"시작"** 클릭

5. **대기 (2-3분)**
   - 상태가 **"실행 중"**으로 변할 때까지 기다림

6. **상태 검사 확인**
   - 하단 **"상태 검사"** 탭에서 2/2 검사 통과 확인

#### ⚠️ 주의사항:
- Public IP가 변경될 수 있습니다!
- 현재 IP: 3.27.28.175
- 변경되면 APK의 URL도 업데이트 필요

---

### 방법 2: 시스템 로그 확인

문제 원인을 파악합니다:

1. **인스턴스 선택**

2. **작업** → **모니터링 및 문제 해결** → **시스템 로그 가져오기**

3. **에러 메시지 찾기:**

**일반적인 에러:**

```bash
# 디스크 풀
"No space left on device"
"disk full"

# 메모리 부족
"Out of memory"
"OOM killer"
"Kernel panic"

# 네트워크 문제
"network unreachable"
"failed to bring up"

# 부팅 실패
"Failed to start"
"systemd[1]: Failed"
```

---

### 방법 3: 인스턴스 타입 확인 및 변경

현재 인스턴스가 리소스 부족일 수 있습니다:

1. **인스턴스 선택**

2. **작업** → **인스턴스 설정** → **인스턴스 유형 변경**

3. **더 큰 타입으로 변경:**
   - 현재: t2.micro 또는 t3.micro?
   - 추천: t3.small 또는 t3.medium

4. **적용 및 시작**

---

### 방법 4: EBS 볼륨 확인

디스크 문제일 수 있습니다:

1. **EC2** → **볼륨** (왼쪽 메뉴)

2. **인스턴스 볼륨 찾기**
   - 인스턴스 ID로 필터링

3. **상태 확인:**
   - ✅ "사용 중" (in-use) → 정상
   - ❌ "오류" (error) → 문제 있음

4. **문제 시 조치:**
   - 볼륨 분리
   - 새 인스턴스에 연결
   - 데이터 복구

---

### 방법 5: 새 인스턴스 생성 (최후의 수단)

위 방법이 모두 실패하면:

#### Option A: AMI에서 복원 (백업이 있는 경우)

1. **EC2** → **AMI** (왼쪽 메뉴)
2. 최신 AMI 선택
3. **시작** 클릭
4. 설정 완료 후 새 인스턴스 시작

#### Option B: 새 인스턴스 생성

1. **인스턴스 시작** 클릭
2. **Ubuntu Server 22.04 LTS** 선택
3. **인스턴스 유형:** t3.small 이상
4. **키 페어:** pumpy-key.pem 사용
5. **보안 그룹:** 기존 것 사용 또는 새로 생성
6. **시작**

#### 새 인스턴스 설정:

```bash
# SSH 접속
ssh -i pumpy-key.pem ubuntu@[새_IP]

# 시스템 업데이트
sudo apt update && sudo apt upgrade -y

# Python & Node.js 설치
sudo apt install python3-pip python3-venv -y
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install nodejs -y

# PM2 설치
sudo npm install -g pm2

# Nginx 설치
sudo apt install nginx -y

# Git 클론
cd ~
git clone https://github.com/BJJTOM/pumpy.git
cd pumpy

# 백엔드 설정
cd gym_api
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python manage.py migrate
python manage.py collectstatic --noinput

# Gunicorn 서비스 설정
sudo nano /etc/systemd/system/gunicorn.service

[Unit]
Description=Gunicorn daemon for Pumpy API
After=network.target

[Service]
User=ubuntu
Group=www-data
WorkingDirectory=/home/ubuntu/pumpy/gym_api
Environment="PATH=/home/ubuntu/pumpy/gym_api/venv/bin"
ExecStart=/home/ubuntu/pumpy/gym_api/venv/bin/gunicorn --workers 3 --bind 0.0.0.0:8000 config.wsgi:application

[Install]
WantedBy=multi-user.target

# 서비스 시작
sudo systemctl start gunicorn
sudo systemctl enable gunicorn

# 프론트엔드 설정
cd ~/pumpy/gym_web
npm install
npm run build
pm2 start npm --name gym-web -- start
pm2 save
pm2 startup

# Nginx 설정
sudo nano /etc/nginx/sites-available/pumpy

server {
    listen 80;
    server_name _;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    location /api {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

sudo ln -s /etc/nginx/sites-available/pumpy /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

---

## 🎯 빠른 조치 (지금!)

### 1단계: 인스턴스 중지 → 시작

AWS 콘솔에서:
```
1. 인스턴스 선택
2. 인스턴스 상태 → 인스턴스 중지
3. 대기 (1-2분)
4. 인스턴스 상태 → 인스턴스 시작
5. 대기 (2-3분)
```

### 2단계: IP 확인

새 IP가 할당되었을 수 있습니다:
- 인스턴스 상세 정보에서 **퍼블릭 IPv4 주소** 확인
- 변경되었으면 메모!

### 3단계: 연결 테스트

PowerShell에서:
```powershell
Test-NetConnection -ComputerName [IP주소] -Port 80
```

---

## 📊 체크리스트

- [ ] 인스턴스 중지 → 시작 시도
- [ ] IP 주소 확인 (변경 여부)
- [ ] 상태 검사 2/2 통과 확인
- [ ] 시스템 로그 확인
- [ ] 필요시 인스턴스 타입 업그레이드
- [ ] 최악의 경우 새 인스턴스 생성

---

## 💡 예방 조치 (복구 후)

### 1. Elastic IP 할당

IP 변경 방지:

1. **EC2** → **탄력적 IP** (왼쪽 메뉴)
2. **탄력적 IP 주소 할당**
3. 할당된 IP를 인스턴스에 연결

### 2. 정기 백업 (AMI)

1. 인스턴스 선택
2. **작업** → **이미지 및 템플릿** → **이미지 생성**
3. 주기적으로 백업

### 3. CloudWatch 알람 설정

- CPU 사용률
- 메모리 사용률
- 디스크 사용률
- 네트워크 트래픽

---

## 📞 긴급 연락

AWS Support:
- https://console.aws.amazon.com/support

문서:
- https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/TroubleshootingInstances.html

---

**작성:** 2025-10-25
**상황:** 재부팅 후에도 연결성 검사 실패
**조치:** 중지 → 시작 필수!

