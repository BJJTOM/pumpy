# 🚨 502 Bad Gateway 에러 해결

## 문제: Nginx가 백엔드와 통신 불가

502 에러는 다음 중 하나가 문제입니다:
1. Gunicorn이 실행되지 않음
2. PM2 (Next.js)가 실행되지 않음
3. 포트 설정 문제

---

## ✅ 빠른 해결 (Session Manager에서)

### 1단계: 서비스 상태 확인

```bash
# Gunicorn 상태
sudo systemctl status gunicorn --no-pager

# PM2 상태
pm2 status

# Nginx 상태
sudo systemctl status nginx --no-pager
```

---

### 2단계: 문제 해결

#### A. Gunicorn 문제

```bash
# Gunicorn 로그 확인
sudo journalctl -u gunicorn -n 50 --no-pager

# Gunicorn 재시작
cd ~/pumpy/gym_api
source venv/bin/activate
sudo systemctl restart gunicorn

# 상태 확인
sudo systemctl status gunicorn
```

#### B. PM2 (Next.js) 문제

```bash
# PM2 로그 확인
pm2 logs gym-web --lines 50 --nostream

# PM2 완전 재시작
pm2 delete gym-web
cd ~/pumpy/gym_web
pm2 start npm --name gym-web -- start
pm2 save

# 상태 확인
pm2 status
```

#### C. Next.js 빌드 실패

```bash
# 빌드 재시도
cd ~/pumpy/gym_web
rm -rf .next node_modules/.cache
npm install
npm run build

# PM2 재시작
pm2 delete gym-web
pm2 start npm --name gym-web -- start
pm2 save
```

---

### 3단계: 포트 확인

```bash
# 8000번 포트 (Gunicorn) 확인
sudo netstat -tlnp | grep 8000

# 3000번 포트 (Next.js) 확인
sudo netstat -tlnp | grep 3000

# 80번 포트 (Nginx) 확인
sudo netstat -tlnp | grep 80
```

---

### 4단계: Nginx 재시작

```bash
# Nginx 설정 테스트
sudo nginx -t

# Nginx 재시작
sudo systemctl restart nginx

# 상태 확인
sudo systemctl status nginx
```

---

## 🎯 완전 재배포 (모든 것이 실패하면)

```bash
# 1. 모든 서비스 중지
pm2 delete gym-web
sudo systemctl stop gunicorn
sudo systemctl stop nginx

# 2. 코드 업데이트
cd ~/pumpy
git pull origin main

# 3. 백엔드 재시작
cd gym_api
source venv/bin/activate
pip install -r requirements.txt
python manage.py migrate
python manage.py collectstatic --noinput
sudo systemctl start gunicorn
sudo systemctl status gunicorn

# 4. 프론트엔드 재빌드
cd ../gym_web
npm install
rm -rf .next
npm run build
pm2 start npm --name gym-web -- start
pm2 save
pm2 status

# 5. Nginx 시작
sudo systemctl start nginx
sudo systemctl status nginx
```

---

## 🔍 로그 확인 명령어

```bash
# Gunicorn 실시간 로그
sudo journalctl -u gunicorn -f

# PM2 실시간 로그
pm2 logs gym-web

# Nginx 에러 로그
sudo tail -f /var/log/nginx/error.log

# Nginx 액세스 로그
sudo tail -f /var/log/nginx/access.log
```

---

## 💡 일반적인 원인

### 1. Next.js 빌드 실패
```bash
cd ~/pumpy/gym_web
npm run build
# 빌드 에러 확인
```

### 2. 포트 충돌
```bash
# 3000번 포트 프로세스 확인
sudo lsof -i :3000
# 필요시 종료
sudo kill -9 [PID]
```

### 3. 메모리 부족
```bash
free -h
# 메모리가 부족하면 swap 추가 또는 인스턴스 업그레이드
```

---

## ✅ 해결 확인

```bash
# 웹 브라우저에서
http://3.27.28.175

# 또는 curl로 테스트
curl -I http://localhost:3000
curl -I http://localhost:8000
curl -I http://3.27.28.175
```

---

작성: 2025-10-25
문제: 502 Bad Gateway
주요 원인: Gunicorn 또는 PM2 서비스 미실행

